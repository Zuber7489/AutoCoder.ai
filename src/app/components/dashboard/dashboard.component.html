<div class="dashboard-container">
  <!-- Sidebar -->
  <div class="sidebar" [class.sidebar-hidden]="!sidebarVisible">
    <!-- Sidebar Header -->
    <div class="sidebar-header">
      <h2><i class="fas fa-robot text-blue-500"></i> AutoCoder.ai</h2>
      <button class="sidebar-toggle md:hidden" (click)="toggleSidebar()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <!-- Language Selector -->
    <div class="language-selector">
      <label class="block text-sm font-medium mb-2">
        <i class="fas fa-code"></i> Programming Language
      </label>
      <div class="relative">
        <select [(ngModel)]="selectedLanguage" class="language-select">
          <option *ngFor="let lang of languages" [value]="lang.value">
            {{ lang.label }}
          </option>
        </select>
        <div class="language-icon">
          <i [class]="getCurrentLanguageIcon()"></i>
        </div>
      </div>
    </div>

    <!-- Chat History Section -->
    <div class="chat-history">
      <div class="chat-history-header">
        <h3><i class="fas fa-history"></i> Chat History</h3>
        <button class="new-chat-btn" (click)="startNewChat()" title="Start New Chat">
          <i class="fas fa-plus"></i>
        </button>
      </div>
      
      <div class="chat-history-list">
        <!-- Current Chat Indicator -->
        <div *ngIf="chatHistories.length === 0" class="no-history">
          <i class="fas fa-comments"></i>
          <span>No chat history yet</span>
        </div>
        
        <!-- Chat History Items -->
        <div 
          *ngFor="let chat of chatHistories; trackBy: trackByChatId" 
          class="history-item"
          [class.active]="chat.id === currentChatId"
          (click)="switchToChat(chat.id)"
          title="{{ chat.title }}">
          
          <div class="history-item-content">
            <div class="history-item-header">
              <div class="history-language">
                <i [class]="getLanguageIcon(chat.language)"></i>
              </div>
              <div class="history-time">{{ getRelativeTime(chat.timestamp) }}</div>
              <button 
                class="delete-chat-btn" 
                (click)="deleteChat(chat.id, $event)"
                title="Delete Chat"
                *ngIf="chatHistories.length > 1">
                <i class="fas fa-trash"></i>
              </button>
            </div>
            
            <div class="history-title">{{ chat.title }}</div>
            <div class="history-preview">{{ chat.lastMessage }}</div>
            
            <div class="history-stats">
              <span class="message-count">
                <i class="fas fa-comment"></i> {{ chat.messages.length }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Examples - Hidden per user request
    <div class="quick-examples">
      <h3><i class="fas fa-lightbulb"></i> Quick Examples</h3>
      <div class="example-buttons">
        <button
          *ngFor="let example of quickExamples"
          class="example-btn"
          (click)="useExample(example)"
          [disabled]="isLoading">
          <i [class]="example.icon"></i>
          {{ example.title }}
        </button>
      </div>
    </div>
    -->

    <!-- API Key Configuration -->
    <div class="api-config">
      <div class="api-config-header">
        <h3><i class="fas fa-key"></i> API Configuration</h3>
        <button class="config-toggle" (click)="toggleApiConfig()" [title]="showApiConfig ? 'Hide API Settings' : 'Show API Settings'">
          <i [class]="showApiConfig ? 'fas fa-chevron-up' : 'fas fa-chevron-down'"></i>
        </button>
      </div>
      
      <div class="api-config-content" [class.expanded]="showApiConfig">
        <div class="api-key-section">
          <label class="block text-sm font-medium mb-2">
            <i class="fas fa-robot"></i> Gemini API Key
          </label>
          <div class="api-key-input-group">
            <input
              type="password"
              [(ngModel)]="customApiKey"
              placeholder="Enter your Gemini API key..."
              class="api-key-input"
              [class.has-key]="hasCustomApiKey"
              (input)="onApiKeyChange()"
            />
            <button
              class="toggle-visibility-btn"
              (click)="toggleApiKeyVisibility()"
              [title]="showApiKey ? 'Hide API Key' : 'Show API Key'">
              <i [class]="showApiKey ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
            </button>
          </div>
          
          <div class="api-key-actions">
            <button
              class="save-key-btn"
              (click)="saveApiKey()"
              [disabled]="!customApiKey?.trim()"
              title="Save API Key">
              <i class="fas fa-save"></i> Save Key
            </button>
            <button
              class="clear-key-btn"
              (click)="clearApiKey()"
              [disabled]="!hasCustomApiKey"
              title="Clear Saved Key">
              <i class="fas fa-trash"></i> Clear
            </button>
          </div>
          
          <div class="api-key-status">
            <div *ngIf="hasCustomApiKey" class="status-success">
              <i class="fas fa-check-circle"></i>
              <span>Using your custom API key</span>
            </div>
            <div *ngIf="!hasCustomApiKey" class="status-default">
              <i class="fas fa-info-circle"></i>
              <span>Using default API key</span>
            </div>
          </div>
          
          <div class="api-key-help">
            <p class="help-text">
              <i class="fas fa-lightbulb"></i>
              Get your free API key from 
              <a href="https://makersuite.google.com/app/apikey" target="_blank" rel="noopener">
                Google AI Studio
              </a>
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Chat Actions -->
    <div class="chat-actions">
      <button class="action-btn" (click)="clearChat()" [disabled]="isLoading">
        <i class="fas fa-trash"></i> Clear Chat
      </button>
      <!-- Export Chat button removed per user request -->
    </div>

    <!-- User Profile Section -->
    <div class="user-profile-section" (click)="openProfileModal()">
      <div class="profile-container">
        <div class="profile-avatar">
          <img 
            *ngIf="userProfilePic" 
            [src]="userProfilePic" 
            [alt]="userDisplayName || 'User'"
            class="profile-image"
            onerror="this.style.display='none'"
          />
          <div 
            *ngIf="!userProfilePic" 
            class="profile-fallback">
            <i class="fas fa-user"></i>
          </div>
        </div>
        <div class="profile-info">
          <div class="profile-name">{{ userDisplayName || 'User' }}</div>
          <div class="profile-email">{{ userEmail || 'Guest' }}</div>
        </div>
        <div class="profile-arrow">
          <i class="fas fa-chevron-right"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Mobile Header -->
    <div class="mobile-header md:hidden">
      <button class="sidebar-toggle" (click)="toggleSidebar()">
        <i class="fas fa-bars"></i>
      </button>
      <h1><i class="fas fa-robot"></i> AutoCoder.ai</h1>
    </div>

    <!-- Chat Container -->
    <div class="chat-container" #chatContainer>
      <!-- Welcome Message -->
      <div *ngIf="conversation.length === 0" class="welcome-message">
        <div class="welcome-icon">
          <i class="fas fa-robot"></i>
        </div>
        <h2>Welcome to AutoCoder.ai</h2>
        <p>Your AI-powered coding assistant. Ask me anything about programming, and I'll help you with code, explanations, and solutions!</p>
        <div class="welcome-features">
          <div class="feature">
            <i class="fas fa-code"></i>
            <span>Code Generation</span>
          </div>
          <div class="feature">
            <i class="fas fa-bug"></i>
            <span>Bug Fixing</span>
          </div>
          <div class="feature">
            <i class="fas fa-lightbulb"></i>
            <span>Code Explanation</span>
          </div>
          <div class="feature">
            <i class="fas fa-search"></i>
            <span>Code Review</span>
          </div>
        </div>
      </div>

      <!-- Conversation Messages -->
      <div *ngFor="let message of conversation; trackBy: trackByMessage" 
           class="message"
           [class.user-message]="message.role === 'user'"
           [class.assistant-message]="message.role === 'assistant'"
           [class.system-message]="message.role === 'system'">
        
        <div class="message-avatar">
          <i *ngIf="message.role === 'user'" class="fas fa-user"></i>
          <i *ngIf="message.role === 'assistant'" class="fas fa-robot"></i>
          <i *ngIf="message.role === 'system'" class="fas fa-info-circle"></i>
        </div>

        <div class="message-content">
          <div class="message-header">
            <span class="message-role">
              {{ message.role === 'user' ? 'You' : message.role === 'assistant' ? 'AutoCoder.ai' : 'System' }}
            </span>
            <span class="message-time">{{ message.timestamp | date:'short' }}</span>
          </div>
          
          <div class="message-text" [innerHTML]="message.content"></div>
          
          <!-- Display generated code if available -->
          <div *ngIf="message.code" class="generated-code">
            <div class="code-header">
              <span class="code-language">
                <i [class]="getLanguageIcon(message.language || selectedLanguage)"></i>
                {{ message.language || selectedLanguage }}
              </span>
              <button class="copy-code-btn" (click)="copyToClipboard(message.code)" title="Copy Code">
                <i class="fas fa-copy"></i>
              </button>
            </div>
            <pre><code class="hljs" [innerHTML]="getHighlightedCode(message.code, message.language)"></code></pre>
          </div>
          
          <!-- Action Buttons for Assistant Messages -->
          <div *ngIf="message.role === 'assistant'" class="message-actions">
            <button class="action-btn-sm" (click)="copyToClipboard(message.code || message.content)" title="Copy">
              <i class="fas fa-copy"></i>
            </button>
            <button *ngIf="message.code" 
                    class="action-btn-sm" 
                    (click)="showPreviewMethod(message.code)" 
                    title="Live Preview">
              <i class="fas fa-eye"></i>
            </button>
            <button class="action-btn-sm" (click)="regenerateResponse(message)" title="Regenerate">
              <i class="fas fa-redo"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Loading Message -->
      <div *ngIf="isLoading" class="message assistant-message loading-message">
        <div class="message-avatar">
          <i class="fas fa-robot magic-pulse"></i>
        </div>
        <div class="message-content">
          <div class="message-header">
            <span class="message-role">AutoCoder.ai</span>
          </div>
          <div class="loading-animation">
            <div class="magic-text-lines">
              <div class="magic-line">🔮 Analyzing your request...</div>
              <div class="magic-line">✨ Conjuring the perfect code...</div>
              <div class="magic-line">🪄 Weaving programming magic...</div>
              <div class="magic-line">⚡ Almost ready to amaze you...</div>
            </div>
            <div class="typing-indicator">
              <span></span>
              <span></span>
              <span></span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Input Area -->
    <div class="input-area">
      <div class="input-container">
        <div class="input-wrapper">
          <textarea
            [(ngModel)]="userInput"
            placeholder="Ask me anything about coding... (Shift + Enter for new line)"
            class="user-input"
            rows="1"
            (keydown)="onKeyDown($event)"
            (input)="autoResize($event)"
            #messageInput>
          </textarea>
          <button
            class="send-button"
            (click)="sendMessage()"
            [disabled]="!userInput.trim() || isLoading"
            [class.loading]="isLoading">
            <i *ngIf="!isLoading" class="fas fa-paper-plane"></i>
            <i *ngIf="isLoading" class="fas fa-spinner fa-spin"></i>
          </button>
        </div>
        <div class="input-footer">
          <span class="input-hint">
            <i class="fas fa-keyboard"></i>
            Press Enter to send, Shift + Enter for new line
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Live Preview Modal -->
  <div *ngIf="showPreviewModal" class="preview-modal" (click)="closePreview()">
    <div class="preview-content" (click)="$event.stopPropagation()">
      <div class="preview-header">
        <h3><i class="fas fa-eye"></i> Live Preview</h3>
        <button class="close-btn" (click)="closePreview()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="preview-body">
        <iframe 
          #previewFrame 
          class="preview-frame"
          sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-modals"
          loading="eager"
          [srcdoc]="previewContent">
        </iframe>
      </div>
    </div>
  </div>

  <!-- Sidebar Overlay for Mobile -->
  <div *ngIf="sidebarVisible" class="sidebar-overlay md:hidden" (click)="toggleSidebar()"></div>

  <!-- Profile Modal -->
  <div *ngIf="showProfileModal" class="profile-modal-overlay" (click)="closeProfileModal()">
    <div class="profile-modal" (click)="$event.stopPropagation()">
      <!-- Modal Header -->
      <div class="modal-header">
        <h2>
          <i class="fas fa-user-cog"></i>
          Profile & Settings
        </h2>
        <button class="close-btn" (click)="closeProfileModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Modal Content -->
      <div class="modal-content">
        <!-- User Profile Section -->
        <div class="profile-section">
          <div class="profile-card">
            <div class="profile-avatar-large">
              <img 
                *ngIf="userProfilePic" 
                [src]="userProfilePic" 
                [alt]="userDisplayName || 'User'"
                class="avatar-image-large"
                onerror="this.style.display='none'"
              />
              <div 
                *ngIf="!userProfilePic" 
                class="avatar-fallback-large">
                <i class="fas fa-user"></i>
              </div>
            </div>
            
            <div class="profile-details">
              <h3>{{ userDisplayName || 'User' }}</h3>
              <p class="profile-email-text">{{ userEmail || 'Guest' }}</p>
              <p class="profile-id" *ngIf="userInfo?.uid">ID: {{ userInfo.uid | slice:0:8 }}...</p>
            </div>
          </div>
        </div>

        <!-- Settings Section -->
        <div class="settings-section">
          <h4>
            <i class="fas fa-cog"></i>
            App Settings
          </h4>
          
          <div class="setting-items">
            <div class="setting-item">
              <div class="setting-info">
                <i class="fas fa-palette"></i>
                <span>Theme</span>
              </div>
              <span class="setting-value">Dark Mode</span>
            </div>
            
            <div class="setting-item">
              <div class="setting-info">
                <i class="fas fa-code"></i>
                <span>Syntax Highlighting</span>
              </div>
              <span class="setting-value active">Enabled</span>
            </div>
            
            <div class="setting-item">
              <div class="setting-info">
                <i class="fas fa-save"></i>
                <span>Auto-save Chat</span>
              </div>
              <span class="setting-value active">On</span>
            </div>
          </div>
        </div>

        <!-- Actions Section -->
        <div class="actions-section">
          <button class="action-btn clear-data" (click)="clearAllData()">
            <i class="fas fa-trash-alt"></i>
            Clear All Data
          </button>
          
          <button 
            class="action-btn logout" 
            (click)="logout()" 
            [disabled]="isLoading">
            <i *ngIf="!isLoading" class="fas fa-sign-out-alt"></i>
            <i *ngIf="isLoading" class="fas fa-spinner fa-spin"></i>
            {{ isLoading ? 'Logging out...' : 'Logout' }}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>